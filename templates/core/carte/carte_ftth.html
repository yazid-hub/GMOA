{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Carte FTTH - Interface Avancée{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
#map {
    height: 80% !important;
    width: 100% !important;
    min-height: 600px !important;
    background-color: #f0f0f0; /* Add this */
    z-index: 15 !important;
    padding-left: 20px !important;
    padding-right: 20px !important;
    margin-bottom: 20px !important;

}

#sidebar{
    z-index: 50 !important;
}
main {
    margin-bottom: 20px !important;
}
 body{
    overflow: hidden !important;
}
.ftth-tool-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 11px;
    font-weight: 500;
}

.ftth-tool-btn:hover {
    background: #f3f4f6;
    border-color: #3b82f6;
}

.ftth-tool-btn.active {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1d4ed8;
}

.ftth-tool-btn i {
    font-size: 16px;
}

/* Animations pour les équipements */
.ftth-equipment-marker-selected {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Ligne de mesure */
.distance-line {
    stroke: #ef4444;
    stroke-width: 3;
    stroke-dasharray: 10, 5;
    animation: dashMove 1s linear infinite;
}

@keyframes dashMove {
    to { stroke-dashoffset: -15; }
}

/* Style for Leaflet Popups */
.ftth-popup .leaflet-popup-content-wrapper {
    border-radius: 8px;
    padding: 0; /* Remove default padding */
}

.ftth-popup .leaflet-popup-content {
    margin: 0;
}

.ftth-popup-header {
    background-color: #f3f4f6;
    padding: 10px 15px;
    border-bottom: 1px solid #e5e7eb;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}

.ftth-popup-content {
    padding: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="w-full h-screen flex flex-col overflow-hidden relative">
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50">
        <div class="relative">
            <input type="text"
                   id="search-input"
                   placeholder="Rechercher un asset..."
                   class="w-96 px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <div id="search-results" class="absolute top-full left-0 right-0 bg-white border border-gray-300 border-t-0 rounded-b-lg max-h-60 overflow-y-auto z-50 hidden shadow-lg"></div>
        </div>
    </div>

    <div class="absolute top-4 left-4 bg-white p-4 rounded-lg shadow-lg z-40 min-w-48 backdrop-blur-sm bg-white/95">
        <h3 class="font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
            Statistiques FTTH
        </h3>
        <div class="space-y-1 text-sm">
            <div class="flex justify-between">
                <span>Total équipements:</span>
                <span class="font-semibold text-blue-600" id="stat-total">{{ stats.total_assets|default:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-green-600">En service:</span>
                <span class="font-semibold text-green-600" id="stat-service">{{ stats.en_service|default:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-red-600">En panne:</span>
                <span class="font-semibold text-red-600" id="stat-panne">{{ stats.en_panne|default:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-yellow-600">Maintenance:</span>
                <span class="font-semibold text-yellow-600" id="stat-maintenance">{{ stats.en_maintenance|default:0 }}</span>
            </div>
            <div class="flex justify-between border-t pt-1 mt-2">
                <span class="text-purple-600">Câbles créés:</span>
                <span class="font-semibold text-purple-600" id="stat-cables">0</span>
            </div>
        </div>
    </div>

    <div class="absolute top-4 right-4 flex space-x-2 z-40">
        <button onclick="toggleSidebar()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-200 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Infos
        </button>
        <button onclick="centrerSurAssets()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-200 flex items-center">
            <i class="fas fa-crosshairs mr-2"></i>
            Centrer
        </button>
        <button onclick="refreshMap()" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-purple-700 transition-all duration-200 flex items-center">
            <i class="fas fa-sync-alt mr-2"></i>
            Actualiser
        </button>
    </div>

    <div id="ftth-tools-palette" class="absolute top-20 right-4 bg-white/95 backdrop-blur-sm p-4 rounded-lg shadow-lg z-40 min-w-48">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-drafting-compass mr-2 text-blue-600"></i>
            Outils FTTH Pro
        </h4>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <button onclick="activateToolMode('nro')" class="ftth-tool-btn" data-tool="nro" title="Nœud de Raccordement Optique">
                <i class="fas fa-server" style="color: #dc2626;"></i>
                <span>NRO</span>
            </button>
            <button onclick="activateToolMode('pm')" class="ftth-tool-btn" data-tool="pm" title="Point de Mutualisation">
                <i class="fas fa-network-wired" style="color: #ea580c;"></i>
                <span>PM</span>
            </button>
            <button onclick="activateToolMode('pb')" class="ftth-tool-btn" data-tool="pb" title="Point de Branchement">
                <i class="fas fa-cube" style="color: #ca8a04;"></i>
                <span>PB</span>
            </button>
            <button onclick="activateToolMode('pto')" class="ftth-tool-btn" data-tool="pto" title="Prise Terminale Optique">
                <i class="fas fa-home" style="color: #16a34a;"></i>
                <span>PTO</span>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <button onclick="activateToolMode('cable')" class="ftth-tool-btn" data-tool="cable" title="Tracer des câbles">
                <i class="fas fa-minus" style="color: #7c3aed;"></i>
                <span>Câble</span>
            </button>
            <button onclick="activateToolMode('cable-connect')" class="ftth-tool-btn" data-tool="cable-connect" title="Raccorder équipements">
                <i class="fas fa-link" style="color: #059669;"></i>
                <span>Raccord</span>
            </button>
            <button onclick="activateToolMode('measure')" class="ftth-tool-btn" data-tool="measure" title="Mesurer distance">
                <i class="fas fa-ruler" style="color: #6b7280;"></i>
                <span>Mesure</span>
            </button>
            <button onclick="activateToolMode('area')" class="ftth-tool-btn" data-tool="area" title="Calculer surface">
                <i class="fas fa-draw-polygon" style="color: #0891b2;"></i>
                <span>Surface</span>
            </button>
        </div>

        <div class="space-y-2">
            <button onclick="clearDrawings()" class="ftth-tool-btn w-full bg-red-50 hover:bg-red-100 text-red-600 border-red-200">
                <i class="fas fa-eraser"></i>
                <span>Effacer tout</span>
            </button>
            <button onclick="saveCurrentWork()" class="ftth-tool-btn w-full bg-green-50 hover:bg-green-100 text-green-600 border-green-200">
                <i class="fas fa-save"></i>
                <span>Sauvegarder</span>
            </button>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="text-xs text-gray-600">Mode actuel:</div>
            <div id="current-mode" class="text-sm font-semibold text-blue-600">Sélection</div>
        </div>
    </div>

    <div class="absolute  bottom-[150px] left-4 bg-white/95 backdrop-blur-sm p-4 rounded-lg shadow-lg z-40 max-w-xs">
        <h4 class="font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
            Légende
        </h4>

        <div class="mb-3">
            <h5 class="text-sm font-medium text-gray-700 mb-1">Statuts</h5>
            <div class="space-y-1 text-xs">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span>En service</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                    <span>En panne</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                    <span>Maintenance</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                    <span>Hors service</span>
                </div>
            </div>
        </div>

        <div>
            <h5 class="text-sm font-medium text-gray-700 mb-1">Équipements FTTH</h5>
            <div class="space-y-1 text-xs">
                <div class="flex items-center">
                    <i class="fas fa-server text-red-600 mr-2"></i>
                    <span>NRO (Nœud Raccordement)</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-network-wired text-orange-600 mr-2"></i>
                    <span>PM (Point Mutualisation)</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-cube text-yellow-600 mr-2"></i>
                    <span>PB (Point Branchement)</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-home text-green-600 mr-2"></i>
                    <span>PTO (Prise Terminale)</span>
                </div>
            </div>
        </div>
    </div>

    <div id="map" class="flex-grow">
        </div>

    <div id="sidebar" class="fixed top-0 right-0 w-80 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 border-l-4 border-blue-500">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Détails Asset</h2>
                <button onclick="closeSidebar()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="sidebar-content" class="space-y-4 flex-grow overflow-y-auto">
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-mouse-pointer text-4xl mb-4 text-gray-300"></i>
                    <p>Sélectionnez un asset sur la carte pour voir ses détails.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="equipment-form-sidebar" class="fixed top-0 right-0 w-96 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 border-l-4 border-blue-500">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-600 flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Nouvel Équipement FTTH
                </h2>
                <button onclick="closeEquipmentForm()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="equipment-form" class="space-y-4 flex-grow overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type d'équipement *</label>
                    <select id="equipment-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Sélectionner le type...</option>
                        <option value="NRO">NRO - Nœud de Raccordement Optique</option>
                        <option value="PM">PM - Point de Mutualisation</option>
                        <option value="PB">PB - Point de Branchement</option>
                        <option value="PTO">PTO - Prise Terminale Optique</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'équipement *</label>
                        <input type="text" id="equipment-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: NRO-PARIS-01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Référence</label>
                        <input type="text" id="equipment-reference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: REF-2025-001">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Marque</label>
                        <select id="equipment-brand" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionner...</option>
                            <option value="Huawei">Huawei</option>
                            <option value="Nokia">Nokia</option>
                            <option value="Ericsson">Ericsson</option>
                            <option value="Alcatel">Alcatel-Lucent</option>
                            <option value="CommScope">CommScope</option>
                            <option value="Corning">Corning</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Modèle</label>
                        <input type="text" id="equipment-model" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: OLT-5680T">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Statut *</label>
                        <select id="equipment-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="EN_SERVICE">En service</option>
                            <option value="EN_PANNE">En panne</option>
                            <option value="EN_MAINTENANCE">En maintenance</option>
                            <option value="HORS_SERVICE">Hors service</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Criticité</label>
                        <select id="equipment-criticality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">Basse</option>
                            <option value="2" selected>Moyenne</option>
                            <option value="3">Haute</option>
                            <option value="4">Critique</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Latitude *</label>
                        <input type="number" id="equipment-lat" step="0.000001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Longitude *</label>
                        <input type="number" id="equipment-lng" step="0.000001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" readonly>
                    </div>
                </div>

                <div id="technical-fields" class="space-y-3 border-t pt-4">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-cogs mr-2 text-blue-600"></i>
                        Spécifications techniques FTTH
                    </h4>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de fibres total</label>
                            <input type="number" id="equipment-fibers-total" min="1" max="288" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 48">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fibres utilisées</label>
                            <input type="number" id="equipment-fibers-used" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 12">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type de connecteur</label>
                        <select id="equipment-connector" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionner...</option>
                            <option value="SC">SC (Standard Connector)</option>
                            <option value="LC">LC (Lucent Connector)</option>
                            <option value="FC">FC (Fiber Channel)</option>
                            <option value="ST">ST (Straight Tip)</option>
                            <option value="E2000">E2000</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adresse/Localisation</label>
                    <textarea id="equipment-location" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adresse précise ou description de l'emplacement"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de mise en service</label>
                        <input type="date" id="equipment-service-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fin de garantie</label>
                        <input type="date" id="equipment-warranty-end" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes et observations</label>
                    <textarea id="equipment-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Informations complémentaires, observations techniques..."></textarea>
                </div>

                <div class="flex space-x-3 pt-4 border-t">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i>
                        Créer l'équipement
                    </button>
                    <button type="button" onclick="closeEquipmentForm()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center justify-center">
                        <i class="fas fa-times mr-2"></i>
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Formulaire câble -->
<div id="cable-form-sidebar" class="fixed top-0 right-0 w-96 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 border-l-4 border-green-500">
    <form id="cable-form" class="p-6 space-y-4">
        <h2 class="text-xl font-bold text-green-600">Nouveau Câble FTTH</h2>
        
        <input type="text" id="cable-name" placeholder="Nom du câble" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
        <input type="number" id="cable-distance" placeholder="Distance (m)" class="w-full px-3 py-2 border border-gray-300 rounded-md" readonly>
        <input type="number" id="cable-fiber-count" placeholder="Nombre de fibres" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
        <select id="cable-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="LC">LC</option>
            <option value="SC">SC</option>
            <option value="FC">FC</option>
        </select>
        
        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Créer le câble</button>
    </form>
</div>
</div>

<div id="notification-container" class="fixed top-20 right-4 z-[9999] space-y-2"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Variables globales
let map;
let drawingLayer;
let currentTool = null;
let currentMarker = null; // Unused, can be removed if not planned for future use
let currentSegment = null; // Used for cable connection logic
let currentCableLine = null; // Represents the temporary line being drawn for cables
let cablePoints = []; // Stores points for free-drawn cables
let cableEquipments = []; // Stores equipment markers selected for cable connection
let measurePoints = []; // Stores points for distance measurement
let cables = []; // Stores all drawn cable objects
let equipments = []; // Stores all loaded equipment objects

// Variables pour les stats
let stats = {
    total: 0,
    en_service: 0,
    en_panne: 0,
    en_maintenance: 0,
    cables: 0
};

// Configuration des couleurs par type d'équipement
const equipmentConfig = {
    'NRO': { color: '#dc2626', iconClass: 'fas fa-server', name: 'NRO' },
    'PM': { color: '#ea580c', iconClass: 'fas fa-network-wired', name: 'Point de Mutualisation' },
    'PB': { color: '#ca8a04', iconClass: 'fas fa-cube', name: 'Point de Branchement' },
    'PTO': { color: '#16a34a', iconClass: 'fas fa-home', name: 'Prise Terminale Optique' }
};

document.addEventListener('DOMContentLoaded', function() {
    if (typeof L === 'undefined') {
        console.error('La bibliothèque Leaflet n\'est pas chargée.');
        showNotification('Erreur: La carte ne peut pas être chargée (Leaflet manquant).', 'error');
        return;
    }

    initializeMap(); // Initialize map and set global variables
    loadExistingAssets();
    setupEventListeners();
    showNotification('Interface FTTH initialisée', 'success');
});

function initializeMap() {
    let centerLatStr = "{{ center_lat|default:'48.8566' }}";
    let centerLngStr = "{{ center_lng|default:'2.3522' }}";

    centerLatStr = centerLatStr.replace(',', '.');
    centerLngStr = centerLngStr.replace(',', '.');

    let centerLat = parseFloat(centerLatStr);
    let centerLng = parseFloat(centerLngStr);

    if (isNaN(centerLat) || isNaN(centerLng)) {
        console.warn('Coordonnées invalides, utilisation des valeurs par défaut (Paris).');
        centerLat = 48.8566;
        centerLng = 2.3522;
    }

    const mapElement = document.getElementById('map');
    if (!mapElement) {
        console.error('L\'élément DOM avec l\'ID "map" n\'existe pas.');
        return;
    }

    // Assign to global map variable
    map = L.map('map').setView([centerLat, centerLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);


    // Assign to global drawingLayer variable
    drawingLayer = L.layerGroup().addTo(map);

    map.on('click', onMapClick);
    map.invalidateSize();
    // Double-click to finish cable drawing
    map.on('dblclick', function(e) {
        if (currentTool === 'cable' && cablePoints.length >= 2) {
            createCableSegment(cablePoints.map(p => [p.lat, p.lng]), {
                startType: 'free',
                endType: 'free',
                startRef: 'Point libre',
                endRef: 'Point libre'
            });

            // Clean up temporary line
            if (currentCableLine) {
                drawingLayer.removeLayer(currentCableLine);
            }

            resetDrawingState();
            showNotification('Câble terminé', 'success');
        } else if (currentTool === 'measure' && measurePoints.length === 1) {
            // If only one point for measurement, double-click acts like a second click
            addMeasurePoint(e.latlng.lat, e.latlng.lng);
        }
    });

    console.log('🗺️ Carte FTTH initialisée avec succès');
}

function loadExistingAssets() {
    console.log('🔄 Chargement des assets existants...');
    
    fetch('/api/ftth/equipment/list/')
        .then(response => response.json())
        .then(data => {
            if (data.success && Array.isArray(data.equipments)) {
                console.log(`✅ ${data.count} équipements chargés`);

                // Charger les équipements (points)
                data.equipments.forEach(equipment => {
                    if (equipment.coordinates) {
                        addEquipmentToMap(equipment);
                    }
                });

                // Charger les câbles (lignes)
                loadCables(data.equipments);
            } else {
                console.error('❌ Erreur lors du chargement:', data.error || 'Aucun équipement reçu');
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau:', error);
        });
}

function loadCables(equipments) {
    equipments.forEach(equipment => {
        if (
            equipment.geometrie_geojson &&
            equipment.geometrie_geojson.type === 'LineString'
        ) {
            addCableToMap(equipment);
        }
    });
}

function addCableToMap(cableData) {
    if (
        !cableData.geometrie_geojson ||
        !cableData.geometrie_geojson.coordinates
    ) return;
    
    const latlngs = cableData.geometrie_geojson.coordinates.map(coord => [coord[1], coord[0]]);
    
    const cableLine = L.polyline(latlngs, {
        color: '#7c3aed',
        weight: 3,
        opacity: 0.8
    }).addTo(map);
    cableLine.bindPopup(`
        <div>
            <h4>📏 ${cableData.name}</h4>
            <p><strong>Type:</strong> Câble FTTH</p>
            <p><strong>Référence:</strong> ${cableData.reference}</p>
            <p><strong>Fibres:</strong> ${cableData.fibers_total || 'N/A'}</p>
            <p><strong>Statut:</strong> ${cableData.status}</p>
        </div>
    `);
}


function openCableForm(cableData) {
    // Remplir les champs du formulaire
    document.getElementById('cable-name').value = `Cable-${Date.now()}`;
    document.getElementById('cable-distance').value = Math.round(cableData.distance);
    document.getElementById('cable-fiber-count').value = '12';
    document.getElementById('cable-type').value = 'LC';
    
    // Afficher le formulaire
    document.getElementById('cable-form-sidebar').classList.remove('translate-x-full');
    
    // Stocker les données temporaires
    window.pendingCableData = cableData;
}
function addEquipmentToMap(equipmentData) {
    if (!equipmentData.coordinates || !drawingLayer) {
        console.error('Données d\'équipement ou drawingLayer manquants pour ajouter à la carte.');
        return;
    }

    const config = equipmentConfig[equipmentData.type] || equipmentConfig['PTO'];
    const statusColor = getStatusColor(equipmentData.status);

    // Create custom icon
    const iconHtml = `<div style="background: ${statusColor}; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        <i class="${config.iconClass}" style="color: white; font-size: 12px;"></i>
                      </div>`;
    const equipmentIcon = L.divIcon({
        html: iconHtml,
        className: 'ftth-equipment-marker',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    const marker = L.marker([equipmentData.coordinates.lat, equipmentData.coordinates.lng], {
        icon: equipmentIcon
    });

    // Enriched popup
    const popupContent = createEquipmentPopup(equipmentData);
    marker.bindPopup(popupContent, { className: 'ftth-popup' });

    // Events
    marker.on('click', function() {
        if (currentTool === 'cable-connect') {
            addEquipmentToCable(marker);
        } else {
            // Show sidebar with equipment details when clicked in selection mode
            displayEquipmentDetailsInSidebar(equipmentData);
            toggleSidebar(); // Open sidebar
        }
    });

    // Store data in the marker for easy access
    marker.equipmentData = equipmentData;

    drawingLayer.addLayer(marker);

    equipments.push({
        marker: marker,
        data: equipmentData
    });
}

function displayEquipmentDetailsInSidebar(equipment) {
    const sidebarContent = document.getElementById('sidebar-content');
    const config = equipmentConfig[equipment.type] || equipmentConfig['PTO'];
    const fibersInfo = equipment.fibers_total ?
        `<div class="text-sm text-gray-700 mt-3">
            <h5 class="font-semibold mb-1">Capacité Fibres:</h5>
            <div class="flex justify-between items-center">
                <span>Utilisées: <span class="font-semibold">${equipment.fibers_used || 0}</span></span>
                <span>Total: <span class="font-semibold">${equipment.fibers_total}</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                <div class="bg-blue-600 h-2 rounded-full" style="width: ${(equipment.fibers_used || 0) / equipment.fibers_total * 100}%"></div>
            </div>
        </div>` : '';

    sidebarContent.innerHTML = `
        <div class="space-y-4">
            <h3 class="text-2xl font-bold text-blue-700 flex items-center">
                <i class="${config.iconClass} mr-3"></i>
                ${equipment.name || 'Équipement'}
            </h3>
            <div class="grid grid-cols-2 gap-y-2 text-gray-700">
                <div><strong>Référence:</strong></div>
                <div>${equipment.reference || 'N/A'}</div>

                <div><strong>Type:</strong></div>
                <div>${config.name}</div>

                <div><strong>Statut:</strong></div>
                <div><span class="px-2 py-1 rounded text-xs bg-${getStatusBgColor(equipment.status)} text-white">${getStatusDisplay(equipment.status)}</span></div>

                ${equipment.brand ? `<div><strong>Marque:</strong></div><div>${equipment.brand}</div>` : ''}
                ${equipment.model ? `<div><strong>Modèle:</strong></div><div>${equipment.model}</div>` : ''}

                <div><strong>Latitude:</strong></div>
                <div>${equipment.coordinates.lat.toFixed(6)}</div>

                <div><strong>Longitude:</strong></div>
                <div>${equipment.coordinates.lng.toFixed(6)}</div>

                ${equipment.connector ? `<div><strong>Connecteur:</strong></div><div>${equipment.connector}</div>` : ''}
            </div>

            ${fibersInfo}

            ${equipment.location ? `
            <div class="mt-4">
                <h5 class="font-semibold mb-1 text-gray-800">Localisation:</h5>
                <p class="text-gray-700">${equipment.location}</p>
            </div>` : ''}

            ${equipment.notes ? `
            <div class="mt-4">
                <h5 class="font-semibold mb-1 text-gray-800">Notes:</h5>
                <p class="text-gray-700">${equipment.notes}</p>
            </div>` : ''}

            <div class="mt-4 flex space-x-2">
                <button onclick="editEquipment(${equipment.id})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-700">
                    <i class="fas fa-edit mr-1"></i>Modifier
                </button>
                <button onclick="deleteEquipment(${equipment.id})" class="flex-1 bg-red-600 text-white px-3 py-2 rounded-md text-sm hover:bg-red-700">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    `;
}


function createEquipmentPopup(equipment) {
    const config = equipmentConfig[equipment.type] || equipmentConfig['PTO'];
    const fibersInfo = equipment.fibers_total ?
        `<div class="text-sm text-gray-600 mt-2">
            <div>Fibres: ${equipment.fibers_used || 0}/${equipment.fibers_total}</div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                <div class="bg-blue-600 h-2 rounded-full" style="width: ${(equipment.fibers_used || 0) / equipment.fibers_total * 100}%"></div>
            </div>
        </div>` : '';

    return `
        <div class="ftth-popup">
            <div class="ftth-popup-header">
                <h3 class="font-bold flex items-center">
                    <i class="${config.iconClass} mr-2"></i>
                    ${equipment.name || 'Équipement'}
                </h3>
                <div class="text-sm opacity-90">${equipment.reference || 'Pas de référence'}</div>
            </div>
            <div class="ftth-popup-content">
                <div class="space-y-2 text-sm">
                    <div><strong>Type:</strong> ${config.name}</div>
                    <div><strong>Statut:</strong> <span class="px-2 py-1 rounded text-xs bg-${getStatusBgColor(equipment.status)} text-white">${getStatusDisplay(equipment.status)}</span></div>
                    ${equipment.brand ? `<div><strong>Marque:</strong> ${equipment.brand}</div>` : ''}
                    ${equipment.model ? `<div><strong>Modèle:</strong> ${equipment.model}</div>` : ''}
                    ${equipment.location ? `<div><strong>Localisation:</strong> ${equipment.location}</div>` : ''}
                    ${fibersInfo}
                </div>
                <div class="flex space-x-2 mt-3">
                    <button onclick="editEquipment(${equipment.id})" class="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                        <i class="fas fa-edit mr-1"></i>Modifier
                    </button>
                    <button onclick="deleteEquipment(${equipment.id})" class="flex-1 bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getStatusColor(status) {
    const colors = {
        'EN_SERVICE': '#10b981',
        'EN_PANNE': '#ef4444',
        'EN_MAINTENANCE': '#f59e0b',
        'HORS_SERVICE': '#6b7280'
    };
    return colors[status] || '#6b7280';
}

function getStatusBgColor(status) {
    const colors = {
        'EN_SERVICE': 'green-500',
        'EN_PANNE': 'red-500',
        'EN_MAINTENANCE': 'yellow-500',
        'HORS_SERVICE': 'gray-500'
    };
    return colors[status] || 'gray-500';
}

function getStatusDisplay(status) {
    const displays = {
        'EN_SERVICE': 'En service',
        'EN_PANNE': 'En panne',
        'EN_MAINTENANCE': 'Maintenance',
        'HORS_SERVICE': 'Hors service'
    };
    return displays[status] || 'Inconnu';
}

function setupEventListeners() {
    document.getElementById('search-input').addEventListener('input', performSearch);
    document.getElementById('equipment-form').addEventListener('submit', createEquipment);
    document.getElementById('equipment-type').addEventListener('change', updateEquipmentForm);
    console.log('🎮 Event listeners configurés');
}

function activateToolMode(tool) {
    // Deactivate previous tool
    if (currentTool) {
        document.querySelector(`[data-tool="${currentTool}"]`)?.classList.remove('active');
    }

    // Reset drawing variables
    resetDrawingState();

    // Activate new tool
    currentTool = tool;
    document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');

    // Update mode display
    document.getElementById('current-mode').textContent = getToolDisplayName(tool);

    // Change map cursor
    map.getContainer().style.cursor = (tool === 'measure' || tool === 'cable' || tool.startsWith('p')) ? 'crosshair' : ''; // 'p' for placement tools (nro, pm, pb, pto)

    showNotification(`Outil activé: ${getToolDisplayName(tool)}`, 'success');
    console.log(`🔧 Outil activé: ${tool}`);
}

function getToolDisplayName(tool) {
    const names = {
        'nro': 'Placement NRO',
        'pm': 'Placement PM',
        'pb': 'Placement PB',
        'pto': 'Placement PTO',
        'cable': 'Tracé libre',
        'cable-connect': 'Raccordement',
        'measure': 'Mesure distance',
        'area': 'Calcul surface'
    };
    return names[tool] || 'Sélection';
}

function onMapClick(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    switch(currentTool) {
        case 'nro':
        case 'pm':
        case 'pb':
        case 'pto':
            openEquipmentForm(lat, lng, currentTool.toUpperCase());
            break;

        case 'cable':
            addCablePoint(lat, lng);
            break;

        case 'measure':
            addMeasurePoint(lat, lng);
            break;

        case 'area':
            // TODO: Implement area calculation
            showNotification('Calcul de surface non encore implémenté.', 'info');
            break;

        default:
            // Selection mode - do nothing specific on map click
            break;
    }
}

function openEquipmentForm(lat, lng, type) {
    // Fill coordinates
    document.getElementById('equipment-lat').value = lat.toFixed(6);
    document.getElementById('equipment-lng').value = lng.toFixed(6);

    // Select type
    document.getElementById('equipment-type').value = type;

    // Generate a default name
    const config = equipmentConfig[type];
    const timestamp = Date.now().toString().slice(-4);
    document.getElementById('equipment-name').value = `${type}-${timestamp}`;

    // Fill default values based on type
    updateEquipmentForm();

    // Open the sidebar
    document.getElementById('equipment-form-sidebar').classList.remove('translate-x-full');

    console.log(`📝 Formulaire ouvert pour ${type} à (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
}

function updateEquipmentForm() {
    const type = document.getElementById('equipment-type').value;
    const technicalFields = document.getElementById('technical-fields');

    if (type) {
        technicalFields.classList.remove('hidden');

        // Default values based on type
        const defaults = {
            'NRO': { fibers: 288, connector: 'LC' },
            'PM': { fibers: 96, connector: 'SC' },
            'PB': { fibers: 24, connector: 'SC' },
            'PTO': { fibers: 4, connector: 'SC' }
        };

        const config = defaults[type];
        if (config) {
            document.getElementById('equipment-fibers-total').value = config.fibers;
            document.getElementById('equipment-connector').value = config.connector;
        }
    } else {
        technicalFields.classList.add('hidden');
    }
}

function createEquipment(e) {
    e.preventDefault();

    // Collect form data
    const formData = {
        type: document.getElementById('equipment-type').value,
        name: document.getElementById('equipment-name').value,
        reference: document.getElementById('equipment-reference').value,
        brand: document.getElementById('equipment-brand').value,
        model: document.getElementById('equipment-model').value,
        status: document.getElementById('equipment-status').value,
        criticality: document.getElementById('equipment-criticality').value,
        latitude: parseFloat(document.getElementById('equipment-lat').value),
        longitude: parseFloat(document.getElementById('equipment-lng').value),
        fibers_total: parseInt(document.getElementById('equipment-fibers-total').value) || null,
        fibers_used: parseInt(document.getElementById('equipment-fibers-used').value) || 0,
        connector: document.getElementById('equipment-connector').value,
        location: document.getElementById('equipment-location').value,
        service_date: document.getElementById('equipment-service-date').value || null,
        warranty_end: document.getElementById('equipment-warranty-end').value || null,
        notes: document.getElementById('equipment-notes').value
    };

    // Validation
    if (!formData.type || !formData.name || isNaN(formData.latitude) || isNaN(formData.longitude)) {
        showNotification('Veuillez remplir tous les champs obligatoires (Type, Nom, Latitude, Longitude).', 'error');
        return;
    }

    // Send to API
    fetch('/api/ftth/equipment/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Server error'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Add to map
            const equipmentData = {
                id: data.asset_id,
                name: formData.name,
                reference: formData.reference,
                type: formData.type,
                brand: formData.brand,
                model: formData.model,
                status: formData.status,
                criticality: formData.criticality,
                coordinates: data.coordinates, // Use coordinates returned by backend
                fibers_total: formData.fibers_total,
                fibers_used: formData.fibers_used,
                location: formData.location
            };

            addEquipmentToMap(equipmentData);
            updateStats();

            // Close form and reset
            closeEquipmentForm();
            document.getElementById('equipment-form').reset();

            showNotification(`Équipement ${formData.name} créé avec succès`, 'success');
            console.log(`✅ Équipement créé: ${formData.name}`);
        } else {
            showNotification(`Erreur: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur création équipement:', error);
        showNotification(`Erreur lors de la création de l'équipement: ${error.message}`, 'error');
    });
}

function addCablePoint(lat, lng) {
    const point = L.latLng(lat, lng);
    cablePoints.push(point);

    // Add a temporary marker
    const marker = L.circleMarker(point, {
        radius: 4,
        fillColor: '#7c3aed',
        color: 'white',
        weight: 2,
        fillOpacity: 0.8
    }).addTo(drawingLayer);

    // Draw the line between points
    if (cablePoints.length > 1) {
        // Remove old line
        if (currentCableLine) {
            drawingLayer.removeLayer(currentCableLine);
        }

        // Create new line
        currentCableLine = L.polyline(cablePoints, {
            color: '#7c3aed',
            weight: 3,
            opacity: 0.7,
            dashArray: '5, 10'
        }).addTo(drawingLayer);
    }

    console.log(`📍 Point câble ajouté: ${cablePoints.length} points`);

    if (cablePoints.length >= 2) {
        showNotification(`${cablePoints.length} points ajoutés. Double-cliquez pour terminer le câble.`, 'info');
    }
}

function addEquipmentToCable(equipmentMarker) {
    // If a free-drawn cable is in progress, connect it to this equipment
    if (cablePoints.length > 0) {
        const equipmentPoint = equipmentMarker.equipmentData.coordinates;

        // Remove temporary line
        if (currentCableLine) {
            drawingLayer.removeLayer(currentCableLine);
        }

        // Create the final segment to the equipment
        const finalPoints = [...cablePoints.map(p => [p.lat, p.lng]), [equipmentPoint.lat, equipmentPoint.lng]];
        createCableSegment(finalPoints, {
            startType: 'free',
            endType: 'equipment',
            startRef: 'Point libre',
            endRef: equipmentMarker.equipmentData.name,
            startId: null, // No ID for free point
            endId: equipmentMarker.equipmentData.id
        });

        console.log(`✅ Câble créé depuis tracé libre vers ${equipmentMarker.equipmentData.name}`);

        // Reset
        resetDrawingState();
        showNotification(`Câble connecté de point libre à ${equipmentMarker.equipmentData.name}`, 'success');
        return;
    }

    // Logic for equipment → equipment connection
    cableEquipments.push(equipmentMarker);

    // Change appearance to show selection
    const equipment = equipmentMarker.equipmentData;
    const config = equipmentConfig[equipment.type] || equipmentConfig['PTO'];

    equipmentMarker.setIcon(L.divIcon({
        html: `<div style="background: ${getStatusColor(equipment.status)}; border: 4px solid #3b82f6; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                 <i class="${config.iconClass}" style="color: white; font-size: 12px;"></i>
               </div>`,
        className: 'ftth-equipment-marker-selected',
        iconSize: [28, 28],
        iconAnchor: [14, 14]
    }));

    // Close popup if open
    if (equipmentMarker.isPopupOpen()) {
        equipmentMarker.closePopup();
    }

    console.log(`📡 Équipement ${equipment.name} sélectionné (${cableEquipments.length})`);

    if (cableEquipments.length === 1) {
        showNotification('Cliquez sur un autre équipement pour créer le câble', 'info');
    } else if (cableEquipments.length >= 2) {
        createCableBetweenEquipments();
    }
}

function createCableBetweenEquipments() {
    if (cableEquipments.length < 2) return;

    // Create line between all selected equipments
    const points = cableEquipments.map(marker => {
        const coords = marker.equipmentData.coordinates;
        return [coords.lat, coords.lng];
    });

    createCableSegment(points, {
        startType: 'equipment',
        endType: 'equipment',
        startRef: cableEquipments[0].equipmentData.name,
        endRef: cableEquipments[cableEquipments.length - 1].equipmentData.name,
        startId: cableEquipments[0].equipmentData.id,
        endId: cableEquipments[cableEquipments.length - 1].equipmentData.id
    });

    console.log(`✅ Câble créé entre ${cableEquipments.length} équipements`);
    showNotification(`Câble créé entre ${cableEquipments[0].equipmentData.name} et ${cableEquipments[cableEquipments.length - 1].equipmentData.name}`, 'success');

    // Reset
    resetCableSelection();
}

function createCableSegment(points, metadata) {
    // Create line on the map
    const line = L.polyline(points, {
        color: '#7c3aed',
        weight: 4,
        opacity: 0.8
    }).addTo(drawingLayer);

    // Calculate distance
    let totalDistance = 0;
    for (let i = 0; i < points.length - 1; i++) {
        const point1 = L.latLng(points[i][0], points[i][1]);
        const point2 = L.latLng(points[i + 1][0], points[i + 1][1]);
        totalDistance += point1.distanceTo(point2);
    }

    // Popup for the cable
    const popupContent = `
        <div class="text-sm">
            <h4 class="font-bold mb-2">Câble FTTH</h4>
            <div><strong>De:</strong> ${metadata.startRef}</div>
            <div><strong>Vers:</strong> ${metadata.endRef}</div>
            <div><strong>Distance:</strong> ${Math.round(totalDistance)}m</div>
            <div class="mt-2">
                <button onclick="deleteCable(${cables.length})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    `;

    line.bindPopup(popupContent);

    // Save to database
    saveCableToDatabase(points, metadata, totalDistance);

    // Add to cable list (store index for deletion)
    cables.push({
        line: line,
        points: points,
        metadata: metadata,
        distance: totalDistance
    });

    // Update stats
    updateStats();
}

function calculateDistance(points) {
    let totalDistance = 0;
    for (let i = 1; i < points.length; i++) {
        totalDistance += points[i-1].distanceTo(points[i]);
    }
    return totalDistance;
}

function saveCableToDatabase() {
    if (cablePoints.length < 2) {
        alert('Il faut au moins 2 points pour créer un câble');
        return;
    }
    
    const totalDistance = calculateDistance(cablePoints);
    const cableName = `Cable-${Date.now()}`;
    
    // Déterminer les références de début et fin
    const startRef = cableEquipments.length > 0 ? cableEquipments[0].equipmentData?.reference || 'Point-debut' : 'Point-debut';
    const endRef = cableEquipments.length > 1 ? cableEquipments[cableEquipments.length-1].equipmentData?.reference || 'Point-fin' : 'Point-fin';
    
    const cableData = {
        name: cableName,
        points: cablePoints.map(p => ({lat: p.lat, lng: p.lng})),
        startRef: startRef,
        endRef: endRef,
        startAssetId: cableEquipments.length > 0 ? cableEquipments[0].equipmentData?.id : null,
        endAssetId: cableEquipments.length > 1 ? cableEquipments[cableEquipments.length-1].equipmentData?.id : null,
        distance: totalDistance,
        fiberCount: 12,
        cableType: 'LC'
    };
    
    console.log('💾 Sauvegarde câble en base avec données:', cableData);
    
    // Sauvegarder le câble
    fetch('/api/ftth/cable/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(cableData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Câble créé:', data);
            alert(`Câble créé avec succès! ID: ${data.cable_asset_id}`);
        } else {
            console.error('❌ Erreur:', data.error);
            alert('Erreur lors de la sauvegarde du câble: ' + data.error);
        }
    })
    .finally(() => {
        // Nettoyer
        cablePoints = [];
        cableEquipments = [];
        currentCableLine = null;
        deactivateToolMode();
    });
}
function finalizeCable() {
    if (cablePoints.length < 2) {
        alert('Il faut au moins 2 points pour créer un câble');
        return;
    }
    
    const totalDistance = calculateDistance(cablePoints);
    const cableName = `Cable-${Date.now()}`;
    
    // Déterminer les références de début et fin
    const startRef = cableEquipments.length > 0 ? cableEquipments[0].equipmentData?.reference || 'Point-debut' : 'Point-debut';
    const endRef = cableEquipments.length > 1 ? cableEquipments[cableEquipments.length-1].equipmentData?.reference || 'Point-fin' : 'Point-fin';
    
    const cableData = {
        name: cableName,
        points: cablePoints.map(p => ({lat: p.lat, lng: p.lng})),
        startRef: startRef,
        endRef: endRef,
        startAssetId: cableEquipments.length > 0 ? cableEquipments[0].equipmentData?.id : null,
        endAssetId: cableEquipments.length > 1 ? cableEquipments[cableEquipments.length-1].equipmentData?.id : null,
        distance: totalDistance,
        fiberCount: 12,
        cableType: 'LC'
    };
    
    // Sauvegarder le câble
    fetch('/api/ftth/cable/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(cableData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Câble créé:', data);
            alert(`Câble créé avec succès! ID: ${data.cable_asset_id}`);
        } else {
            console.error('❌ Erreur:', data.error);
            alert('Erreur lors de la sauvegarde du câble: ' + data.error);
        }
    })
    .finally(() => {
        // Nettoyer
        cablePoints = [];
        cableEquipments = [];
        currentCableLine = null;
        deactivateToolMode();
    });
}
function addMeasurePoint(lat, lng) {
    const point = L.latLng(lat, lng);
    measurePoints.push(point);

    // Add a marker
    const marker = L.circleMarker(point, {
        radius: 5,
        fillColor: '#ef4444',
        color: 'white',
        weight: 2,
        fillOpacity: 1
    }).addTo(drawingLayer);

    if (measurePoints.length === 2) {
        // Calculate and display distance
        const distance = measurePoints[0].distanceTo(measurePoints[1]);

        // Measurement line
        const line = L.polyline(measurePoints, {
            color: '#ef4444',
            weight: 3,
            dashArray: '10, 5',
            className: 'distance-line'
        }).addTo(drawingLayer);

        // Popup with distance
        const midpoint = L.latLng(
            (measurePoints[0].lat + measurePoints[1].lat) / 2,
            (measurePoints[0].lng + measurePoints[1].lng) / 2
        );

        const popup = L.popup()
            .setLatLng(midpoint)
            .setContent(`
                <div class="text-center">
                    <div class="font-bold text-lg">${Math.round(distance)}m</div>
                    <div class="text-sm text-gray-600">Distance mesurée</div>
                    <button onclick="clearMeasure()" class="mt-2 bg-red-600 text-white px-2 py-1 rounded text-xs">
                        Effacer
                    </button>
                </div>
            `)
            .openOn(map);

        showNotification(`Distance mesurée: ${Math.round(distance)}m`, 'success');

        // Reset for the next measurement
        measurePoints = [];
    } else if (measurePoints.length === 1) {
        showNotification('Cliquez une deuxième fois pour mesurer la distance.', 'info');
    }
}

function resetDrawingState() {
    currentSegment = null;
    // Remove any temporary cable line being drawn
    if (currentCableLine) {
        drawingLayer.removeLayer(currentCableLine);
        currentCableLine = null;
    }
    // Remove temporary cable points markers
    drawingLayer.eachLayer(layer => {
        if (layer instanceof L.CircleMarker && layer.options.fillColor === '#7c3aed') {
            drawingLayer.removeLayer(layer);
        }
    });
    cablePoints = [];
    measurePoints = []; // Clear measure points on tool change
    resetCableSelection();
}

function resetCableSelection() {
    // Revert equipment appearance to normal
    cableEquipments.forEach(marker => {
        const equipment = marker.equipmentData;
        const config = equipmentConfig[equipment.type] || equipmentConfig['PTO'];

        marker.setIcon(L.divIcon({
            html: `<div style="background: ${getStatusColor(equipment.status)}; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                     <i class="${config.iconClass}" style="color: white; font-size: 12px;"></i>
                   </div>`,
            className: 'ftth-equipment-marker',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        }));
    });

    // Reset the list
    cableEquipments = [];
}

function clearDrawings() {
    if (confirm('Êtes-vous sûr de vouloir effacer tous les dessins (câbles et mesures) ? Cela ne supprimera pas les équipements existants.')) {
        // Remove only cables and measurement lines/markers from the drawing layer
        drawingLayer.eachLayer(layer => {
            // Check if it's a cable (polyline with specific color/weight) or measurement element
            if ((layer instanceof L.Polyline && layer.options.color === '#7c3aed') || // Cables
                (layer instanceof L.Polyline && layer.options.dashArray === '10, 5') || // Measurement lines
                (layer instanceof L.CircleMarker && layer.options.fillColor === '#ef4444') || // Measurement points
                (layer instanceof L.CircleMarker && layer.options.fillColor === '#7c3aed')) { // Temporary cable points
                drawingLayer.removeLayer(layer);
            }
            // Do NOT remove equipment markers here as they are handled 
        });

        resetDrawingState();
        cables = []; // Clear the cables array
        // Re-load equipments to ensure only valid equipments are on the map
        loadExistingAssets();
        updateStats();
        showNotification('Tous les dessins ont été effacés', 'success');
    }
}

function clearMeasure() {
    // Effacer les éléments de mesure de la dernière mesure
    drawingLayer.eachLayer(layer => {
        if (layer instanceof L.CircleMarker && layer.options.fillColor === '#ef4444') {
            drawingLayer.removeLayer(layer);
        }
        if (layer instanceof L.Polyline && layer.options.dashArray === '10, 5') {
            drawingLayer.removeLayer(layer);
        }
    });

    map.closePopup();
    measurePoints = [];
    showNotification('Mesure effacée.', 'info');
}

function saveCurrentWork() {
    // This function can be expanded to save current map state or new drawings if not already persisted
    // For now, it's just a notification as equipment and cable creation already persist to DB.
    showNotification('Le travail est automatiquement sauvegardé lors de la création d\'équipements et de câbles.', 'info');
    console.log('💾 Travail sauvegardé: Les créations sont persistées.');
}

function updateStats() {
    stats.total = equipments.length;
    stats.en_service = equipments.filter(e => e.data.status === 'EN_SERVICE').length;
    stats.en_panne = equipments.filter(e => e.data.status === 'EN_PANNE').length;
    stats.en_maintenance = equipments.filter(e => e.data.status === 'EN_MAINTENANCE').length;
    stats.cables = cables.length;

    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-service').textContent = stats.en_service;
    document.getElementById('stat-panne').textContent = stats.en_panne;
    document.getElementById('stat-maintenance').textContent = stats.en_maintenance;
    document.getElementById('stat-cables').textContent = stats.cables;
}

function performSearch() {
    const query = document.getElementById('search-input').value.trim();
    const resultsContainer = document.getElementById('search-results');

    if (query.length < 2) {
        resultsContainer.classList.add('hidden');
        resultsContainer.innerHTML = ''; // Clear previous results
        return;
    }

    fetch(`/api/assets/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                let html = '';
                data.results.slice(0, 5).forEach(asset => {
                    html += `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="focusOnAsset(${asset.latitude}, ${asset.longitude})">
                            <div class="font-medium">${asset.nom}</div>
                            <div class="text-sm text-gray-600">${asset.reference || 'Pas de référence'}</div>
                            <div class="text-xs text-gray-500">${asset.categorie}</div>
                        </div>
                    `;
                });
                resultsContainer.innerHTML = html;
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500">Aucun résultat trouvé</div>';
                resultsContainer.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Erreur recherche:', error);
            resultsContainer.classList.add('hidden');
            showNotification('Erreur lors de la recherche des assets.', 'error');
        });
}

function focusOnAsset(lat, lng) {
    map.setView([lat, lng], 16);
    document.getElementById('search-results').classList.add('hidden');
    document.getElementById('search-input').value = '';
    showNotification('Asset localisé sur la carte', 'success');

    // Optionally highlight the asset if it's already on the map
    const targetEquipment = equipments.find(e => e.data.coordinates.lat === lat && e.data.coordinates.lng === lng);
    if (targetEquipment) {
        targetEquipment.marker.openPopup();
        // Add a temporary animation class if needed
        targetEquipment.marker._icon.classList.add('ftth-equipment-marker-selected');
        setTimeout(() => {
            targetEquipment.marker._icon.classList.remove('ftth-equipment-marker-selected');
        }, 3000); // Remove highlight after 3 seconds
    }
}

function centrerSurAssets() {
    if (equipments.length === 0) {
        showNotification('Aucun équipement à centrer', 'warning');
        return;
    }

    const group = new L.featureGroup(equipments.map(e => e.marker));
    map.fitBounds(group.getBounds().pad(0.1));
    showNotification(`Vue centrée sur ${equipments.length} équipements`, 'success');
}

function refreshMap() {
    // Clear the drawing layer completely before reloading to avoid duplicates
    drawingLayer.clearLayers();
    equipments.length = 0; // Reset local equipments array
    cables.length = 0; // Reset local cables array

    loadExistingAssets(); // This will repopulate `equipments` and `drawingLayer`
    showNotification('Carte actualisée', 'success');
}

function editEquipment(assetId) {
    showNotification('Fonction d\'édition en cours de développement', 'warning');
    // In a real application, you'd fetch the equipment details by assetId,
    // populate the equipment form with those details, and change the form's
    // submit action to an update API call instead of create.
    // openEquipmentForm(lat, lng, type) could be reused with pre-filled values.
}

function deleteEquipment(assetId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet équipement ?')) {
        fetch(`/api/ftth/equipment/${assetId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Server error'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove from map and local array
                const equipmentIndex = equipments.findIndex(e => e.data.id === assetId);
                if (equipmentIndex !== -1) {
                    drawingLayer.removeLayer(equipments[equipmentIndex].marker);
                    equipments.splice(equipmentIndex, 1);
                }

                // Also remove any cables connected to this equipment (client-side only for now, backend should handle cascading)
                cables = cables.filter(cable => {
                    const isConnected = (cable.metadata.startId === assetId || cable.metadata.endId === assetId);
                    if (isConnected) {
                        drawingLayer.removeLayer(cable.line);
                    }
                    return !isConnected;
                });


                updateStats();
                showNotification(data.message, 'success');
                map.closePopup();
                closeSidebar(); // Close sidebar if it was showing details of deleted asset
            } else {
                showNotification(`Erreur: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Erreur suppression:', error);
            showNotification(`Erreur lors de la suppression: ${error.message}`, 'error');
        });
    }
}

function deleteCable(cableIndex) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce câble ?')) {
        if (cableIndex >= 0 && cableIndex < cables.length) {
            const cableToDelete = cables[cableIndex];

            // In a real app, you'd send a DELETE request to your backend for the cable's ID
            // For now, it's just client-side removal
            // fetch(`/api/ftth/cable/${cableToDelete.id}/delete/`, { ... })

            drawingLayer.removeLayer(cableToDelete.line);
            cables.splice(cableIndex, 1); // Remove from array
            updateStats();
            map.closePopup();
            showNotification('Câble supprimé', 'success');

            // Re-index deleteCable buttons in popups if needed (more complex, consider using unique IDs)
        }
    }
}

// Sidebar management functions
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('translate-x-full');
    // Ensure form sidebar is closed if main sidebar is opened
    closeEquipmentForm();
}

function closeSidebar() {
    document.getElementById('sidebar').classList.add('translate-x-full');
}

function closeEquipmentForm() {
    document.getElementById('equipment-form-sidebar').classList.add('translate-x-full');
    resetDrawingState(); // Ensure drawing state is cleared when closing form
    // Also deactivate the tool if it was a placement tool
    if (currentTool && ['nro', 'pm', 'pb', 'pto'].includes(currentTool)) {
        document.querySelector(`[data-tool="${currentTool}"]`)?.classList.remove('active');
        currentTool = null;
        map.getContainer().style.cursor = '';
        document.getElementById('current-mode').textContent = 'Sélection';
    }
}

// Notification system
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');

    const bgColors = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
    };

    const icons = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-triangle',
        'warning': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle'
    };

    notification.className = `${bgColors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 transform transition-all duration-300 translate-x-full opacity-0`;
    notification.innerHTML = `
        <i class="${icons[type]}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
        </button>
    `;

    container.appendChild(notification);

    // Entry animation
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
    }, 100);

    // Automatic removal after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Utility function to get CSRF token
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape to cancel current tool
    if (e.key === 'Escape') {
        if (currentTool) {
            document.querySelector(`[data-tool="${currentTool}"]`)?.classList.remove('active');
            currentTool = null;
            resetDrawingState();
            map.getContainer().style.cursor = '';
            document.getElementById('current-mode').textContent = 'Sélection';
            showNotification('Outil désactivé', 'info');
        } else if (document.getElementById('sidebar').classList.contains('translate-x-full') === false) {
            // If sidebar is open, close it
            closeSidebar();
        } else if (document.getElementById('equipment-form-sidebar').classList.contains('translate-x-full') === false) {
            // If equipment form is open, close it
            closeEquipmentForm();
        }
    }

    // Ctrl+Z for undo last cable drawing action
    if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        undoLastAction();
    }

    // Delete key to clear drawings
    if (e.key === 'Delete') {
        clearDrawings();
    }
});

function undoLastAction() {
    if (cablePoints.length > 0) {
        // Remove the last point and its marker for free-drawn cable
        cablePoints.pop();
        // Remove the last circle marker added for cable points (assuming it's the last one in drawingLayer)
        const layers = drawingLayer.getLayers();
        for (let i = layers.length - 1; i >= 0; i--) {
            if (layers[i] instanceof L.CircleMarker && layers[i].options.fillColor === '#7c3aed') {
                drawingLayer.removeLayer(layers[i]);
                break; // Only remove the last one
            }
        }

        if (currentCableLine) {
            drawingLayer.removeLayer(currentCableLine);
            currentCableLine = null;
        }
        if (cablePoints.length > 1) {
            currentCableLine = L.polyline(cablePoints, {
                color: '#7c3aed',
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 10'
            }).addTo(drawingLayer);
        }
        showNotification('Dernier point du câble supprimé', 'info');
    } else if (cables.length > 0) {
        // Remove the last created cable
        const lastCable = cables.pop();
        drawingLayer.removeLayer(lastCable.line);
        // TODO: In a real app, send a DELETE request to backend for this cable
        updateStats();
        showNotification('Dernier câble supprimé', 'info');
    } else {
        showNotification('Aucune action à annuler', 'warning');
    }
}

// Window resize handling
window.addEventListener('resize', function() {
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
});

// Advanced functions for nearby equipment
function findNearbyEquipments(lat, lng, radius = 100) {
    return fetch(`/api/ftth/equipment/nearby/?lat=${lat}&lng=${lng}&radius=${radius}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                return data.equipments;
            }
            return [];
        })
        .catch(error => {
            console.error('Erreur recherche équipements proches:', error);
            showNotification(`Erreur lors de la recherche d'équipements proches: ${error.message}`, 'error');
            return [];
        });
}

// Real-time form validation
document.getElementById('equipment-name').addEventListener('input', function() {
    const value = this.value.trim();
    if (value.length < 3 && value.length > 0) {
        this.classList.add('border-red-500');
        this.classList.remove('border-green-500');
    } else if (value.length >= 3) {
        this.classList.remove('border-red-500');
        this.classList.add('border-green-500');
    } else {
        this.classList.remove('border-red-500', 'border-green-500');
    }
});

document.getElementById('equipment-fibers-total').addEventListener('input', function() {
    const fibersUsedInput = document.getElementById('equipment-fibers-used');
    const fibersUsed = parseInt(fibersUsedInput.value) || 0;
    const fibersTotal = parseInt(this.value) || 0;

    if (fibersUsed > fibersTotal && fibersTotal > 0) {
        fibersUsedInput.value = fibersTotal;
        showNotification('Fibres utilisées ajustées automatiquement (ne peut dépasser le total).', 'warning');
    }
    updateFiberOccupationDisplay();
});

document.getElementById('equipment-fibers-used').addEventListener('input', function() {
    const fibersUsed = parseInt(this.value) || 0;
    const fibersTotal = parseInt(document.getElementById('equipment-fibers-total').value) || 0;

    if (fibersUsed < 0) {
        this.value = 0;
        showNotification('Fibres utilisées ne peut être négatif.', 'warning');
    } else if (fibersUsed > fibersTotal && fibersTotal > 0) {
        this.value = fibersTotal;
        showNotification('Fibres utilisées ajustées automatiquement (ne peut dépasser le total).', 'warning');
    }
    updateFiberOccupationDisplay();
});

function updateFiberOccupationDisplay() {
    const fibersUsed = parseInt(document.getElementById('equipment-fibers-used').value) || 0;
    const fibersTotal = parseInt(document.getElementById('equipment-fibers-total').value) || 0;

    if (fibersTotal > 0) {
        const occupation = ((fibersUsed / fibersTotal) * 100).toFixed(1);
        // You could update a visible element like a span next to the input
        // For now, logging to console:
        console.log(`Taux d'occupation: ${occupation}%`);
    }
}


// Export data (bonus feature)
function exportMapData() {
    const data = {
        equipments: equipments.map(e => ({
            id: e.data.id,
            name: e.data.name,
            type: e.data.type,
            coordinates: e.data.coordinates,
            status: e.data.status,
            reference: e.data.reference,
            brand: e.data.brand,
            model: e.data.model,
            fibers_total: e.data.fibers_total,
            fibers_used: e.data.fibers_used,
            connector: e.data.connector,
            location: e.data.location,
            service_date: e.data.service_date,
            warranty_end: e.data.warranty_end,
            notes: e.data.notes
        })),
        cables: cables.map(c => ({
            points: c.points,
            distance: c.distance,
            metadata: c.metadata
        })),
        exportDate: new Date().toISOString(),
        stats: stats
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `carte_ftth_export_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification('Données exportées avec succès', 'success');
}

// Add export button (optional)
// You can uncomment this and decide where to place the button.
/*
const exportButton = document.createElement('button');
exportButton.innerHTML = '<i class="fas fa-download mr-2"></i>Export';
exportButton.className = 'bg-purple-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-purple-700 transition-all duration-200 flex items-center';
exportButton.onclick = exportMapData;
// Append button to controls if necessary (e.g., in the top-right controls div)
// document.querySelector('.absolute.top-4.right-4').appendChild(exportButton);
*/

console.log('🚀 Interface FTTH complètement initialisée');

// Analytics and monitoring (optional)
function trackUserAction(action, details = {}) {
    console.log(`📊 Action utilisateur: ${action}`, details);
    // Here you could send data to an analytics service
}

// Tracker specific actions
const originalActivateToolMode = activateToolMode;
activateToolMode = function(tool) {
    trackUserAction('tool_activated', { tool });
    return originalActivateToolMode(tool);
};

const originalCreateEquipment = createEquipment;
createEquipment = function(e) {
    trackUserAction('equipment_created', {
        type: document.getElementById('equipment-type').value
    });
    return originalCreateEquipment(e);
};

// Periodic auto-save (draft) - currently just logs, can be extended for actual client-side draft saving
setInterval(function() {
    if (equipments.length > 0 || cables.length > 0) {
        const draftData = {
            equipmentsCount: equipments.length,
            cablesCount: cables.length,
            lastSave: new Date().toISOString()
        };
        // Example of saving to localStorage. This would NOT persist drawings or actual equipment data, just counts.
        // For actual data persistence, you'd need to serialize equipment/cable objects.
        localStorage.setItem('ftth_draft_summary', JSON.stringify(draftData));
        console.log('💾 Draft automatique sauvegardé (summary only)');
    }
}, 300000); // Every 5 minutes

// Restore draft on load if available (summary only)
window.addEventListener('load', function() {
    const draftSummary = localStorage.getItem('ftth_draft_summary');
    if (draftSummary) {
        try {
            const draftData = JSON.parse(draftSummary);
            if (draftData.equipmentsCount > 0 || draftData.cablesCount > 0) {
                showNotification(`Draft précédent détecté. Dernier enregistrement: ${new Date(draftData.lastSave).toLocaleTimeString()}`, 'info');
            }
        } catch (error) {
            console.error('Erreur lecture draft:', error);
        }
    }
});

</script>
{% endblock %}