{% extends 'core/base.html' %}
{% load static %}

{% block title %}Carte FTTH - Assets{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS uniquement -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Fix dimensions carte avec Tailwind -->
<style>
#map {
    height: 100vh !important;
    width: 100% !important;
    min-height: 600px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="w-full h-screen overflow-hidden">
    <!-- Barre de recherche -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50">
        <div class="relative">
            <input type="text" 
                   id="search-input"
                   placeholder="Rechercher un asset..."
                   class="w-96 px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div id="search-results" class="absolute top-full left-0 right-0 bg-white border border-gray-300 border-t-0 rounded-b-lg max-h-60 overflow-y-auto z-50 hidden"></div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="absolute top-4 left-4 bg-white p-4 rounded-lg shadow-lg z-40 min-w-48">
        <h3 class="font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
            Stats
        </h3>
        <div class="space-y-1 text-sm">
            <div class="flex justify-between">
                <span>Total:</span>
                <span class="font-semibold">{{ stats.total_assets|default:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-green-600">Service:</span>
                <span class="font-semibold">{{ stats.en_service|default:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-red-600">Panne:</span>
                <span class="font-semibold">{{ stats.en_panne|default:0 }}</span>
            </div>
        </div>
    </div>

    <!-- Boutons -->
    <div class="absolute top-4 right-4 space-x-2 z-40">
        <button onclick="toggleSidebar()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-700">
            <i class="fas fa-info-circle"></i>
        </button>
        <button onclick="centrerSurAssets()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700">
            üéØ Centrer
        </button>
        <button onclick="debugCarte()" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-red-700">
            üîß Debug
        </button>
        <button onclick="refreshPage()" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-700">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- L√©gende -->
    <div class="absolute bottom-4 left-4 bg-white p-4 rounded-lg shadow-lg z-40">
        <h4 class="font-bold text-gray-800 mb-2">Statuts</h4>
        <div class="space-y-2 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <span>En service</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                <span>En panne</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2"></div>
                <span>Maintenance</span>
            </div>
        </div>
    </div>

    <!-- Carte - DIMENSIONS FORC√âES -->
    <div id="map" style="height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 10;"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 right-0 w-80 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50">
        <div class="p-6 h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">D√©tails Asset</h2>
                <button onclick="closeSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="sidebar-content">
                <p class="text-gray-500">S√©lectionnez un asset sur la carte.</p>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================
let map = null;
let assetsLayer = null;

// Coordonn√©es par d√©faut (Paris)
const DEFAULT_LAT = 48.8566;
const DEFAULT_LNG = 2.3522;

// ==========================================
// PR√âPARATION DES DONN√âES
// ==========================================
let assetsData = null;
let centerLat = DEFAULT_LAT;
let centerLng = DEFAULT_LNG;

// R√©cup√©ration s√©curis√©e des donn√©es Django avec DIAGNOSTIC COMPLET
try {
    console.log('üîç Variables Django re√ßues:');
    console.log('- assets_geojson:', '{{ assets_geojson|escapejs }}');
    console.log('- center_lat:', '{{ center_lat|default:"UNDEFINED" }}');
    console.log('- center_lng:', '{{ center_lng|default:"UNDEFINED" }}');
    console.log('- stats:', '{{ stats|default:"UNDEFINED" }}');

    const rawData = {{ assets_geojson|safe }};
    console.log('üìä Donn√©es brutes re√ßues:', rawData);
    
    if (rawData && rawData.features) {
        assetsData = rawData;
        console.log('‚úÖ Assets charg√©s:', assetsData.features.length);
        console.log('üìã Premier asset:', assetsData.features[0]);
    } else {
        console.log('‚ùå Pas de donn√©es assets ou format incorrect');
        assetsData = { type: "FeatureCollection", features: [] };
    }
} catch (e) {
    console.error('‚ùå Erreur donn√©es assets:', e);
    assetsData = { type: "FeatureCollection", features: [] };
}

// Centre de la carte avec diagnostic
try {
    const backendLat = parseFloat("{{ center_lat|default:'' }}");
    const backendLng = parseFloat("{{ center_lng|default:'' }}");
    
    console.log('üéØ Centre re√ßu du backend:', backendLat, backendLng);
    
    if (!isNaN(backendLat) && !isNaN(backendLng)) {
        centerLat = backendLat;
        centerLng = backendLng;
        console.log('‚úÖ Centre depuis backend:', centerLat, centerLng);
    } else {
        console.log('‚ö†Ô∏è Centre backend invalide, utilisation centre par d√©faut (Paris)');
    }
} catch (e) {
    console.log('‚ö†Ô∏è Erreur centre, utilisation par d√©faut:', e);
}

// ==========================================
// INITIALISATION CARTE
// ==========================================
function initMap() {
    try {
        console.log('üó∫Ô∏è Initialisation carte...');
        console.log('üìç Centre utilis√©:', centerLat, centerLng);
        
        // Cr√©er la carte
        map = L.map('map').setView([centerLat, centerLng], 10);
        console.log('‚úÖ Objet carte cr√©√©');

        // Ajouter les tuiles avec √©v√©nements de diagnostic
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        });
        
        tileLayer.on('loading', function() {
            console.log('üì° Chargement des tuiles...');
        });
        
        tileLayer.on('load', function() {
            console.log('‚úÖ Tuiles charg√©es avec succ√®s');
        });
        
        tileLayer.on('tileerror', function(e) {
            console.error('‚ùå Erreur chargement tuile:', e);
        });
        
        tileLayer.addTo(map);
        console.log('‚úÖ Couche de tuiles ajout√©e');

        // FORCER LE REDIMENSIONNEMENT DE LA CARTE
        setTimeout(() => {
            console.log('üîÑ Redimensionnement forc√© de la carte...');
            map.invalidateSize();
            console.log('‚úÖ Carte redimensionn√©e');
        }, 100);

        // Test de la carte
        console.log('üß™ Test carte - Zoom actuel:', map.getZoom());
        console.log('üß™ Test carte - Centre actuel:', map.getCenter());

        // Ajouter les assets
        addAssets();
        
        console.log('‚úÖ Carte compl√®tement initialis√©e');
        
    } catch (error) {
        console.error('‚ùå Erreur init carte:', error);
        
        // Afficher l'erreur dans l'interface
        const mapDiv = document.getElementById('map');
        if (mapDiv) {
            mapDiv.innerHTML = `
                <div class="flex items-center justify-center h-full bg-red-50">
                    <div class="text-center p-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-lg font-bold text-red-700 mb-2">Erreur de carte</h3>
                        <p class="text-red-600 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            Recharger
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

// ==========================================
// AJOUT DES ASSETS
// ==========================================
function addAssets() {
    try {
        if (!assetsData || !assetsData.features || assetsData.features.length === 0) {
            console.log('‚ö†Ô∏è Aucun asset √† afficher');
            return;
        }

        // Filtrer les assets avec coordonn√©es valides
        const validFeatures = assetsData.features.filter(feature => {
            if (!feature.geometry || !feature.geometry.coordinates) return false;
            const coords = feature.geometry.coordinates;
            return Array.isArray(coords) && coords.length === 2 && 
                   !isNaN(coords[0]) && !isNaN(coords[1]);
        });

        console.log('üìç Assets valides:', validFeatures.length);

        if (validFeatures.length === 0) {
            console.log('‚ö†Ô∏è Aucun asset avec coordonn√©es valides');
            return;
        }

        // Cr√©er la couche GeoJSON
        assetsLayer = L.geoJSON({ 
            type: "FeatureCollection", 
            features: validFeatures 
        }, {
            pointToLayer: function(feature, latlng) {
                const props = feature.properties || {};
                const color = getStatusColor(props.statut);
                
                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function(feature, layer) {
                const props = feature.properties || {};
                
                // Popup simple
                const popup = `
                    <div class="p-2">
                        <h3 class="font-bold">${props.nom || 'Asset'}</h3>
                        <p class="text-sm">Statut: ${props.statut || 'Inconnu'}</p>
                        <button onclick="showDetails(${props.id || 0})" class="mt-2 bg-blue-500 text-white px-2 py-1 rounded text-xs">
                            D√©tails
                        </button>
                    </div>
                `;
                
                layer.bindPopup(popup);
                
                // Clic pour d√©tails
                layer.on('click', function() {
                    if (props.id) {
                        showDetails(props.id);
                    }
                });
            }
        }).addTo(map);

        console.log('‚úÖ Assets ajout√©s √† la carte');
        
    } catch (error) {
        console.error('‚ùå Erreur ajout assets:', error);
    }
}

// ==========================================
// FONCTIONS UTILITAIRES
// ==========================================
function getStatusColor(statut) {
    switch ((statut || '').toLowerCase()) {
        case 'en service': return '#10b981';
        case 'en panne': return '#ef4444';
        case 'en maintenance': return '#f59e0b';
        default: return '#6b7280';
    }
}

// ==========================================
// SIDEBAR
// ==========================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.classList.toggle('translate-x-full');
    }
}

function openSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.classList.remove('translate-x-full');
    }
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.classList.add('translate-x-full');
    }
}

// ==========================================
// D√âTAILS ASSET
// ==========================================
function showDetails(assetId) {
    if (!assetId) return;
    
    const content = document.getElementById('sidebar-content');
    if (!content) return;
    
    // Loading
    content.innerHTML = `
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
            <p>Chargement...</p>
        </div>
    `;
    
    openSidebar();
    
    // Requ√™te AJAX (optionnelle - peut √™tre remplac√©e par donn√©es locales)
    setTimeout(() => {
        try {
            // Chercher l'asset dans les donn√©es locales
            const asset = findAssetById(assetId);
            if (asset) {
                content.innerHTML = createAssetHTML(asset);
            } else {
                content.innerHTML = '<p class="text-red-500">Asset non trouv√©</p>';
            }
        } catch (error) {
            console.error('Erreur d√©tails:', error);
            content.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
        }
    }, 500);
}

function findAssetById(id) {
    if (!assetsData || !assetsData.features) return null;
    
    const feature = assetsData.features.find(f => 
        f.properties && f.properties.id == id
    );
    
    return feature ? feature.properties : null;
}

function createAssetHTML(asset) {
    return `
        <div>
            <h3 class="text-lg font-bold mb-2">${asset.nom || 'Asset'}</h3>
            <div class="space-y-2 text-sm">
                <p><strong>R√©f√©rence:</strong> ${asset.reference || 'N/A'}</p>
                <p><strong>Cat√©gorie:</strong> ${asset.categorie || 'N/A'}</p>
                <p><strong>Statut:</strong> ${asset.statut || 'N/A'}</p>
                <p><strong>Localisation:</strong> ${asset.localisation || 'N/A'}</p>
            </div>
            <div class="mt-4 space-y-2">
                <button onclick="editAsset(${asset.id})" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                    Modifier
                </button>
            </div>
        </div>
    `;
}

// ==========================================
// RECHERCHE
// ==========================================
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            searchTimeout = setTimeout(() => searchAssets(query), 300);
        });
    }
});

function searchAssets(query) {
    if (!assetsData || !assetsData.features) return;
    
    const results = assetsData.features
        .filter(f => {
            const props = f.properties || {};
            const nom = (props.nom || '').toLowerCase();
            const ref = (props.reference || '').toLowerCase();
            return nom.includes(query.toLowerCase()) || ref.includes(query.toLowerCase());
        })
        .slice(0, 10); // Limiter √† 10 r√©sultats
    
    showSearchResults(results);
}

function showSearchResults(features) {
    const container = document.getElementById('search-results');
    if (!container) return;
    
    if (features.length === 0) {
        container.innerHTML = '<div class="p-3 text-gray-500">Aucun r√©sultat</div>';
    } else {
        container.innerHTML = features.map(feature => {
            const props = feature.properties || {};
            const coords = feature.geometry.coordinates;
            
            return `
                <div class="p-3 border-b hover:bg-gray-50 cursor-pointer" onclick="selectResult(${coords[1]}, ${coords[0]}, ${props.id})">
                    <div class="font-medium">${props.nom || 'Asset'}</div>
                    <div class="text-sm text-gray-600">${props.reference || ''}</div>
                </div>
            `;
        }).join('');
    }
    
    container.classList.remove('hidden');
}

function hideSearchResults() {
    const container = document.getElementById('search-results');
    if (container) {
        container.classList.add('hidden');
    }
}

function selectResult(lat, lng, assetId) {
    if (map && !isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], 15);
    }
    
    hideSearchResults();
    document.getElementById('search-input').value = '';
    
    if (assetId) {
        setTimeout(() => showDetails(assetId), 500);
    }
}

// ==========================================
// AUTRES FONCTIONS
// ==========================================
function refreshPage() {
    location.reload();
}

function centrerSurAssets() {
    console.log('üéØ Centrage automatique sur les assets...');
    
    if (!assetsData || !assetsData.features || assetsData.features.length === 0) {
        console.log('‚ùå Aucun asset pour centrage');
        return;
    }
    
    // Calculer les bounds des assets
    let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
    
    assetsData.features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        const lat = coords[1];
        const lng = coords[0];
        
        minLat = Math.min(minLat, lat);
        maxLat = Math.max(maxLat, lat);
        minLng = Math.min(minLng, lng);
        maxLng = Math.max(maxLng, lng);
    });
    
    console.log(`üìä Bounds calcul√©s: lat[${minLat}, ${maxLat}], lng[${minLng}, ${maxLng}]`);
    
    // Centrer la carte sur tous les assets
    const bounds = [[minLat, minLng], [maxLat, maxLng]];
    map.fitBounds(bounds, { padding: [50, 50] });
    
    console.log('‚úÖ Carte centr√©e sur tous les assets');
}

function debugCarte() {
    console.log('üîß DIAGNOSTIC COMPLET DE LA CARTE:');
    console.log('- Objet map:', map);
    console.log('- Container map:', document.getElementById('map'));
    console.log('- Dimensions container:', document.getElementById('map').getBoundingClientRect());
    console.log('- Assets data:', assetsData);
    console.log('- Centre carte:', map ? map.getCenter() : 'MAP NON D√âFINIE');
    console.log('- Zoom carte:', map ? map.getZoom() : 'MAP NON D√âFINIE');
    
    if (map) {
        console.log('üîÑ Tentative de r√©paration...');
        map.invalidateSize();
        setTimeout(() => {
            map.invalidateSize();
            console.log('‚úÖ Carte r√©par√©e');
        }, 100);
    }
    
    alert('Voir console pour diagnostic complet');
}

function editAsset(assetId) {
    if (assetId) {
        window.open(`/admin/core/asset/${assetId}/change/`, '_blank');
    }
}

// Fermer recherche au clic ext√©rieur
document.addEventListener('click', function(e) {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    
    if (searchInput && searchResults && 
        !searchInput.contains(e.target) && 
        !searchResults.contains(e.target)) {
        hideSearchResults();
    }
});

// ==========================================
// INITIALISATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ D√©marrage carte FTTH');
    
    setTimeout(() => {
        try {
            initMap();
        } catch (error) {
            console.error('üí• Erreur fatale:', error);
            alert('Erreur fatale: ' + error.message);
        }
    }, 100);
});
</script>
{% endblock %}